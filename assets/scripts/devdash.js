const skeletonPage=' <section class="loader-container">\n    \n    \n    <div class="loading-text">\n      Loading<i>.</i><i>.</i><i>.</i>\n    </div>\n    \n    \n    <div class="subtitle">Preparing your experience</div>\n    \n    \x3c!-- Product skeleton cards --\x3e\n    <div class="skeleton-preview">\n      <div class="skeleton-card">\n        <div class="skeleton-img"></div>\n        <div class="skeleton-line"></div>\n        <b class="skeleton-line"></b>\n        <div class="skeleton-line"></div>\n      </div>\n      <div class="skeleton-card">\n        <div class="skeleton-img"></div>\n        <div class="skeleton-line"></div>\n        <b class="skeleton-line"></b>\n        <div class="skeleton-line"></div>\n      </div>\n      <div class="skeleton-card">\n        <div class="skeleton-img"></div>\n        <div class="skeleton-line"></div>\n        <b class="skeleton-line"></b>\n        <div class="skeleton-line"></div>\n      </div>\n      <div class="skeleton-card">\n        <div class="skeleton-img"></div>\n        <div class="skeleton-line"></div>\n        <b class="skeleton-line"></b>\n        <div class="skeleton-line"></div>\n      </div>\n      <div class="skeleton-card">\n        <div class="skeleton-img"></div>\n        <div class="skeleton-line"></div>\n        <b class="skeleton-line"></b>\n        <div class="skeleton-line"></div>\n      </div>\n      <div class="skeleton-card">\n        <div class="skeleton-img"></div>\n        <div class="skeleton-line"></div>\n        <b class="skeleton-line"></b><div class="skeleton-line"></div>\n      </div>\n      \n    </div>\n  </section>';import{createClient}from"https://esm.sh/@supabase/supabase-js@2";import{unw}from"./unw3bbd34z.js";function formatLength(e){const t=200-e.length;return t>=1?e+="&nbsp ".repeat(t):e}let authBio="creator",authImg="/assets/images/default.png",authName="creator",authSkill="creator",portfolioUrl=" ",authFname="creator",authStatus="pending",rewBalance=0;const{url:url,key:key}={url:td,key:tc};export const supabase=createClient(url,key);async function getUser(){const{data:e,error:t}=await supabase.auth.getUser();return t?(console.error("Auth error:",t),null):e?.user||null}async function signOut(){await supabase.auth.signOut(),window.location.href="/signup.html"}function cunw(e){const t=unw(),a=e.toLowerCase();return t.some((e=>new RegExp(`\\b${e}\\b`,"i").test(a)))}async function loadProfile(){const e=await getUser();if(!e)return void(window.location.href="/signup.html");document.querySelector(".user .email").textContent=e.email,document.querySelector(".user .uid").textContent=e.id;const t=new Date(e.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});document.querySelector(".join-date").textContent=t;const a=new Date(e.last_sign_in_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});document.querySelector(".last-login").textContent=a;const{data:n}=await supabase.from("profiles").select("*").eq("id",e.id).single();n&&(document.querySelector("#account-status").textContent=n.status,document.querySelector(".status").style.color="pending"===document.querySelector("#account-status").textContent?"#960":"#096",document.getElementById("userName").value=n.username?.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")||"",document.getElementById("top-username").textContent=n.username?.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")||"",document.getElementById("fullName").value=n.full_name?.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")||"",document.getElementById("email").value=e.email,document.getElementById("phone").value=n.phone||"",document.getElementById("bio").value=n.bio?.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")||"",document.getElementById("preview-bio").textContent=n.bio?.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")||"",document.getElementById("skill").value=n.skills||"",document.getElementById("portfolio").value=n.portfolio_url||"",document.querySelector(".user.img").src=n.photo_url||"/assets/images/default.png",document.getElementById("profileName").textContent=n.full_name?.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")||n.username||"User",document.getElementById("profileSkill").textContent=n.skills||"No skill set",document.getElementById("profileName").innerHTML+=` <sup style="font-size: 0.6em;-webkit-text-stroke: 0.2px #0f9;">${"verified"===n.status?'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="14" height="14" viewBox="0 0 256 256" xml:space="preserve">\n<g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">\n\t<path d="M 49.66 1.125 L 49.66 1.125 c 4.67 -2.393 10.394 -0.859 13.243 3.548 l 0 0 c 1.784 2.761 4.788 4.495 8.071 4.66 l 0 0 c 5.241 0.263 9.431 4.453 9.694 9.694 v 0 c 0.165 3.283 1.899 6.286 4.66 8.071 l 0 0 c 4.407 2.848 5.941 8.572 3.548 13.242 l 0 0 c -1.499 2.926 -1.499 6.394 0 9.319 l 0 0 c 2.393 4.67 0.859 10.394 -3.548 13.242 l 0 0 c -2.761 1.784 -4.495 4.788 -4.66 8.071 v 0 c -0.263 5.241 -4.453 9.431 -9.694 9.694 h 0 c -3.283 0.165 -6.286 1.899 -8.071 4.66 l 0 0 c -2.848 4.407 -8.572 5.941 -13.242 3.548 l 0 0 c -2.926 -1.499 -6.394 -1.499 -9.319 0 l 0 0 c -4.67 2.393 -10.394 0.859 -13.242 -3.548 l 0 0 c -1.784 -2.761 -4.788 -4.495 -8.071 -4.66 h 0 c -5.241 -0.263 -9.431 -4.453 -9.694 -9.694 l 0 0 c -0.165 -3.283 -1.899 -6.286 -4.66 -8.071 l 0 0 C 0.266 60.054 -1.267 54.33 1.125 49.66 l 0 0 c 1.499 -2.926 1.499 -6.394 0 -9.319 l 0 0 c -2.393 -4.67 -0.859 -10.394 3.548 -13.242 l 0 0 c 2.761 -1.784 4.495 -4.788 4.66 -8.071 l 0 0 c 0.263 -5.241 4.453 -9.431 9.694 -9.694 l 0 0 c 3.283 -0.165 6.286 -1.899 8.071 -4.66 l 0 0 c 2.848 -4.407 8.572 -5.941 13.242 -3.548 l 0 0 C 43.266 2.624 46.734 2.624 49.66 1.125 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: var(--primary-color); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/>\n\t<polygon points="36.94,66.3 36.94,66.3 36.94,46.9 36.94,46.9 62.8,35.34 72.5,45.04 " style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: var(--primary-color); fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>\n\t<polygon points="36.94,66.3 17.5,46.87 27.2,37.16 36.94,46.9 60.11,23.7 69.81,33.39 " style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>\n</g>\n</svg>':"<br/><a href='#/premium/'<span>Get verified badge </span></a>"}</sup>`,authBio=n.bio||"",authImg=n.photo_url||"/assets/images/default.png",authName=n.username||"",authSkill=n.skills||"",authStatus=n.status||"",authFname=n.full_name||"",portfolioUrl=n.portfolio_url||"",rewBalance=n.rew||0,updateBioCharCount()),await loadProfileStats()}function updateBioCharCount(){const e=document.getElementById("bio"),t=document.getElementById("bioCharCount");e&&t&&(t.textContent=e.value.length,e.addEventListener("input",(()=>{t.textContent=e.value.length})))}async function loadProfileStats(){const e=await getUser();if(!e)return;const{data:t}=await supabase.from("posts").select("sales, price").eq("user_id",e.id);if(t){const e=t.length,a=t.reduce(((e,t)=>e+(t.sales||0)),0),n=t.reduce(((e,t)=>e+(t.price||0)*(t.sales||0)),0);document.getElementById("statUploads").textContent=e,document.getElementById("summary-uploads").textContent=e,document.getElementById("statSales").textContent=a,document.getElementById("statEarnings").onclick=()=>{cAlert(`â‚¦${fn(n||0)}`,"success","Total earnings")}}}document.getElementById("logoutBtn").onclick=signOut;const zipInput=document.getElementById("zipInput"),filename=document.querySelector(".file-name");zipInput&&(zipInput.onchange=()=>{filename&&(filename.textContent=zipInput.files[0]?.name||"")});const publisherForm=document.getElementById("publisherForm");async function initStar(e){try{const{count:t,error:a}=await supabase.from("stars").select("*",{count:"exact",head:!0}).eq("post_id",e);if(a)throw a;return t||0}catch(e){return console.error("Star init failed:",e),0}}async function deletePost(e){if(confirm(`Delete "${e.name}"? This cannot be undone.`))try{const{error:t}=await supabase.from("stars").delete().eq("post_id",e.id);if(t)return console.error("SDB delete error:",t),void cAlert("Failed to delete related stars.","warning","Error");if(e.file_path){const{error:t}=await supabase.storage.from("uploads").remove([e.file_path]);if(t)return console.error("Storage delete error:",t),void cAlert("Failed to delete file from storage.","warning","Failed")}const{error:a}=await supabase.from("posts").delete().eq("id",e.id);if(a)return console.error("DB delete error:",a),void cAlert("Failed to delete post from Database.","warning","Failed");cAlert("Post deleted!","success","Deleted"),loadPosts(),loadSalesSummary(),loadSalesChart(),renderPerformanceChart()}catch(e){console.error("Unexpected error:",e),cAlert("An unexpected error occurred.","warning","Error")}}async function loadPosts(){try{const e=await getUser();if(!e)return void console.warn("No logged-in user found.");const{data:t,error:a}=await supabase.from("posts").select("id, name, description, price, cover, auth_bio, auth_img, auth_name, star, sales, auth_skill, portfolio_url, auth_fname, auth_status, sponsored, created_at").eq("user_id",e.id).order("created_at",{ascending:!1});if(a)throw a;const n=document.querySelector(".product-grid");if(!n)return;if(n.innerHTML="",!t||0===t.length)return void(n.innerHTML='<p class="empty-msg">You haven\'t uploaded any posts yet.\n      <br/>\n      <a href="#/pen/">\n      <svg viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="#000000" style="opacity: 0.7;"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M512 301.2m-10 0a10 10 0 1 0 20 0 10 10 0 1 0-20 0Z" fill="#E73B37"></path><path d="M400.3 744.5c2.1-0.7 4.1-1.4 6.2-2-2 0.6-4.1 1.3-6.2 2z m0 0c2.1-0.7 4.1-1.4 6.2-2-2 0.6-4.1 1.3-6.2 2z" fill="#39393A"></path><path d="M511.8 256.6c24.4 0 44.2 19.8 44.2 44.2S536.2 345 511.8 345s-44.2-19.8-44.2-44.2 19.9-44.2 44.2-44.2m0-20c-35.5 0-64.2 28.7-64.2 64.2s28.7 64.2 64.2 64.2 64.2-28.7 64.2-64.2-28.7-64.2-64.2-64.2z" fill="#E73B37"></path><path d="M730.7 529.5c0.4-8.7 0.6-17.4 0.6-26.2 0-179.6-86.1-339.1-219.3-439.5-133.1 100.4-219.2 259.9-219.2 439.5 0 8.8 0.2 17.5 0.6 26.1-56 56-90.6 133.3-90.6 218.7 0 61.7 18 119.1 49.1 167.3 30.3-49.8 74.7-90.1 127.7-115.3 39-18.6 82.7-29 128.8-29 48.3 0 93.9 11.4 134.3 31.7 52.5 26.3 96.3 67.7 125.6 118.4 33.4-49.4 52.9-108.9 52.9-173.1 0-85.4-34.6-162.6-90.5-218.6zM351.1 383.4c9.2-37.9 22.9-74.7 40.6-109.5a502.1 502.1 0 0 1 63.6-95.9c17.4-20.6 36.4-39.9 56.8-57.5 20.4 17.6 39.4 36.9 56.8 57.5 24.8 29.5 46.2 61.8 63.6 95.9 17.7 34.8 31.4 71.6 40.6 109.5 8.7 35.8 13.5 72.7 14.2 109.9C637.4 459 577 438.9 512 438.9c-65 0-125.3 20.1-175.1 54.4 0.7-37.2 5.5-74.1 14.2-109.9z m-90.6 449.2c-9.1-27-13.7-55.5-13.7-84.4 0-35.8 7-70.6 20.8-103.2 8.4-19.8 19-38.4 31.9-55.5 9.7 61.5 29.5 119.7 57.8 172.6-36.4 17.8-69 41.6-96.8 70.5z m364.2-85.3c-0.7-0.3-1.5-0.5-2.2-0.8-0.4-0.2-0.9-0.3-1.3-0.5-0.6-0.2-1.3-0.5-1.9-0.7-0.8-0.3-1.5-0.5-2.3-0.8-0.8-0.3-1.5-0.5-2.3-0.7l-0.9-0.3c-1-0.3-2.1-0.7-3.1-1-1.2-0.4-2.4-0.7-3.5-1.1l-3-0.9c-0.2-0.1-0.4-0.1-0.7-0.2-1.1-0.3-2.3-0.7-3.4-1-1.2-0.3-2.4-0.6-3.5-0.9l-3.6-0.9-3.6-0.9c-1-0.3-2.1-0.5-3.1-0.7-1.2-0.3-2.4-0.5-3.6-0.8-1.3-0.3-2.5-0.6-3.8-0.8h-0.3c-0.9-0.2-1.9-0.4-2.8-0.6-0.4-0.1-0.7-0.1-1.1-0.2-1.1-0.2-2.2-0.4-3.4-0.6-1.2-0.2-2.4-0.4-3.6-0.7l-5.4-0.9c-0.9-0.1-1.9-0.3-2.8-0.4-0.8-0.1-1.6-0.3-2.5-0.4-2.6-0.4-5.1-0.7-7.7-1-1.2-0.1-2.3-0.3-3.5-0.4h-0.4c-0.9-0.1-1.8-0.2-2.8-0.3-1.1-0.1-2.1-0.2-3.2-0.3-1.7-0.2-3.4-0.3-5.1-0.4-0.8-0.1-1.5-0.1-2.3-0.2-0.9-0.1-1.9-0.1-2.8-0.2-0.4 0-0.8 0-1.2-0.1-1.1-0.1-2.1-0.1-3.2-0.2-0.5 0-1-0.1-1.5-0.1-1.3-0.1-2.6-0.1-3.9-0.1-0.8 0-1.5-0.1-2.3-0.1-1.2 0-2.4 0-3.5-0.1h-13.9c-2.3 0-4.6 0.1-6.9 0.2-0.9 0-1.9 0.1-2.8 0.1-0.8 0-1.5 0.1-2.3 0.1-1.4 0.1-2.8 0.2-4.1 0.3-1.4 0.1-2.7 0.2-4.1 0.3-1.4 0.1-2.7 0.2-4.1 0.4-0.6 0-1.2 0.1-1.8 0.2l-7.8 0.9c-1.1 0.1-2.1 0.3-3.2 0.4-1 0.1-2.1 0.3-3.1 0.4-3.2 0.5-6.4 0.9-9.5 1.5-0.7 0.1-1.4 0.2-2.1 0.4-0.9 0.1-1.7 0.3-2.6 0.5-1.1 0.2-2.3 0.4-3.4 0.6-0.9 0.2-1.7 0.3-2.6 0.5-0.4 0.1-0.8 0.1-1.1 0.2-0.7 0.1-1.4 0.3-2.1 0.4-1.2 0.3-2.4 0.5-3.6 0.8-1.2 0.3-2.4 0.5-3.6 0.8-0.2 0-0.4 0.1-0.6 0.1-0.5 0.1-1 0.2-1.5 0.4-1.1 0.3-2.3 0.6-3.5 0.9-1.3 0.3-2.5 0.6-3.8 1-0.4 0.1-0.9 0.2-1.4 0.4-1.3 0.4-2.7 0.7-4 1.1-1.5 0.4-3 0.9-4.6 1.3-1 0.3-2.1 0.6-3.1 1-2.1 0.6-4.1 1.3-6.2 2-0.7 0.2-1.4 0.5-2.1 0.7-15-27.5-27.4-56.4-37-86.2-11.7-36.1-19.2-73.6-22.5-111.6-0.6-6.7-1-13.3-1.3-20-0.1-1.2-0.1-2.4-0.1-3.6-0.1-1.2-0.1-2.4-0.1-3.6 0-1.2-0.1-2.4-0.1-3.6 0-1.2-0.1-2.4-0.1-3.7 18.8-14 39.2-25.8 61-35 36.1-15.3 74.5-23 114.1-23 39.6 0 78 7.8 114.1 23 21.8 9.2 42.2 20.9 61 35v0.1c0 1 0 1.9-0.1 2.9 0 1.4-0.1 2.8-0.1 4.3 0 0.7 0 1.3-0.1 2-0.1 1.8-0.1 3.5-0.2 5.3-0.3 6.7-0.8 13.3-1.3 20-3.3 38.5-11 76.5-23 113-9.7 30.3-22.3 59.4-37.6 87.1z m136.8 90.9a342.27 342.27 0 0 0-96.3-73.2c29.1-53.7 49.5-112.8 59.4-175.5 12.8 17.1 23.4 35.6 31.8 55.5 13.8 32.7 20.8 67.4 20.8 103.2 0 31-5.3 61.3-15.7 90z" fill="#39393A"></path><path d="M512 819.3c8.7 0 24.7 22.9 24.7 60.4s-16 60.4-24.7 60.4-24.7-22.9-24.7-60.4 16-60.4 24.7-60.4m0-20c-24.7 0-44.7 36-44.7 80.4 0 44.4 20 80.4 44.7 80.4s44.7-36 44.7-80.4c0-44.4-20-80.4-44.7-80.4z" fill="#E73B37"></path></g></svg>\n      <h4><I class="fas fa-plus"></i> Start selling</h4>\n      </a>\n      </p>\n      ');t.forEach((e=>{const t=document.createElement("div");t.className="card",t.dataset.id=e.id,t.dataset.filePath=e.file_path,t.dataset.sellerId=e.user_id,t.dataset.profileId=e.user_id,t.innerHTML=`\n        <div class="product-img" style="background-image: url(${e.cover||"/assets/images/index.png"});">\n          <h3 class="delete-btn"><i class="fas fa-trash"></i></h3>\n          <a href="/home.html#search?q=${encodeURIComponent(e.description?.slice(0,200).replace(/\&amp\;/,"&").replace(/&gt;/,">").replace(/&lt;/,"<"))}"><h4 data-view="${e.viewer||"https://media.tenor.com/aGgnqxZUzeUAAAAM/sad.gif"}"><i class="fas fa-eye"></i></h4></a>\n        </div>\n  <p class="product-describe" onclick="location.href='/p?id=${e.id}'">\n    <strong>${e.name?.slice(0,35).replace(/</g,"&lt;").replace(/>/g,"&gt;")}${e.name.length>35?"â€¦":""}  </strong><br>\n    ${formatLength(e.description?.slice(0,200).replace(/</g,"&lt;").replace(/>/g,"&gt;"))}${e.description.length>200?"â€¦":""}\n  </p>\n  <input type="button" value="${new Date(e.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}">\n        <div class="profile" data-bio="${e.auth_bio||""} â€¢ ${e.auth_skill||""}">\n          <p><img src="${e.auth_img||e.cover||"/assets/images/default.png"}" alt="User_auth-profile">\n          <strong class="user-name">${e.auth_name?e.auth_name:e.name.slice(0,10).replace(/</g,"&lt;").replace(/>/g,"&gt;")}</strong></p>\n        </div>\n        <div class="buttons">\n          <span class="star-contain"> <button class="star" data-post-id="${e.id}" style="cursor: pointer; background: none; border: none; color: inherit;">\n        <svg width="23" height="23" viewBox="0 0 24 24" fill="currentColor">\n          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>\n        </svg></button><span class="star-count"></span></span> <span class="amount" data-price="${e.price||0}">â‚¦${fn(e.price||0)} <small><b class="sales">${e.sales?e.sales:0}</b> sold</small></span>\n          <a name="${e.id}"><span class="star-contain"><i class="fas fa-share"></i> </span></a>\n        </div>\n      `;n.querySelectorAll(".card").forEach((e=>{e.querySelector(".product-describe");e&&e.querySelector(".buttons a").addEventListener("click",(t=>{navigator.clipboard.writeText(`https://devtem.org/p?id=${e.querySelector(".buttons a").name||""}`),cAlert("Link copied ðŸŽ‰","success","Copied")}))})),t.querySelector(".delete-btn").onclick=()=>deletePost(e),n.appendChild(t)}))}catch(e){console.error("Error loading posts:",e)}}publisherForm&&(publisherForm.onsubmit=async e=>{e.preventDefault(),document.querySelector(".sending").style.display="inline-block";const t=await getUser();if(!t)return cAlert("Please log in.");const a=zipInput.files[0];if(!a)return cAlert("Select a ZIP file","warning","Alert");if(cunw(document.getElementById("cardName").value?.toLowerCase())||cunw(document.getElementById("cardDes").value?.toLowerCase()))return document.querySelector(".sending").style.display="none",cAlert("can't be published, it contains content that may break our community guidelines","warning","UNW");const{data:n,error:r}=await supabase.storage.from("uploads").upload(`${t.id}/${a.name}`,a,{upsert:!0});if(r)return console.error(r),document.querySelector(".sending").style.display="none",cAlert("Upload failed.","warning","Error");const{error:o}=await supabase.from("posts").insert({user_id:t.id,name:document.getElementById("cardName").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),description:document.getElementById("cardDes").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),cover:document.getElementById("cardCover").value,viewer:document.getElementById("cardView").value,price:parseFloat(document.getElementById("cardAmount").value),file_path:n.path,star:0,sales:0,auth_bio:authBio,auth_img:authImg,auth_name:authName,auth_skill:authSkill,auth_status:authStatus,auth_fname:authFname,portfolio_url:portfolioUrl});if(o)return console.error(o),document.querySelector(".sending").style.display="none",cAlert("Insert failed.","warning","Error");document.querySelector(".sending").style.display="none",loadPosts(),loadProfileStats(),cAlert("Upload successful!","success","Success"),showSection("posts"),publisherForm.reset()});const profileForm=document.querySelector('form[name="user edit"]');profileForm&&profileForm.addEventListener("submit",(async e=>{e.preventDefault();const t=profileForm.querySelector(".username").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").trim(),a=document.getElementById("fullName").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").trim(),n=profileForm.querySelector(".bio").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").trim(),r=profileForm.querySelector(".skill").value,o=document.getElementById("phone").value,s=(document.getElementById("experience"),document.getElementById("portfolio").value),i=document.getElementById("imgUrl").files[0];if(cunw(t||"")||cunw(n||"")||cunw(a||""))return cAlert("can't be published, it contains content that may break our community guidelines","warning","UNW");if(a.length<=2||n.length<=2||t.length<=2)return cAlert("Profile update failed. Please provide complete and valid information.","warning","USER_INFO");try{const{data:{user:e},error:l}=await supabase.auth.getUser();if(l||!e)throw new Error("Not logged in");let c=null;if(i){const t=i.name.split(".").pop(),a=`avatars/${e.id}.${t}`,{error:n}=await supabase.storage.from("avatars").upload(a,i,{upsert:!0});if(n)throw n;const{data:r}=supabase.storage.from("avatars").getPublicUrl(a);c=r.publicUrl}const{error:d}=await supabase.from("profiles").update({username:t,full_name:a,bio:n,skills:r,phone:o,portfolio_url:s,...c&&{photo_url:c}}).eq("id",e.id);if(d)throw d;cAlert("Profile updated!","success","Success"),loadProfile()}catch(e){console.error("Profile update error:",e.message),cAlert("Error updating profile: "+e.message,"warning","Error")}}));const notificationForm=document.getElementById("notificationForm");async function loadSalesSummary(){const e=await getUser();if(e){try{const{data:t,error:a}=await supabase.from("posts").select("id, price, sales, name").eq("user_id",e.id);if(a)return void console.error("Sales summary error:",a);if(!t||0===t.length){const e=document.querySelector(".sales-stats");return void(e&&(e.innerHTML="<p>No products uploaded yet.</p>"))}let n=0,r=0;t.forEach((e=>{const t=e.sales||0,a=e.price||0;n+=a*t,r+=t}));const o=await getAvailableBalance(),s=document.querySelector(".sales-stats");s&&(s.innerHTML=`\n        <div class="summary-card">\n           <i class=""></i>\n                     <div>\n                <p>Total Sales Value: </p>\n                <strong class="contain-number">â‚¦${fn(n)}</strong>\n                </div>\n                   <div class="progress">\n  <div class="range" style="max-width: ${n/550>=100?100:n/550}%;"></div>\n</div>\n                </div>\n        <div class="summary-card">\n           <i class=""></i>\n                     <div>\n                <p>Units Sold:</p> <strong class="contain-number">${fn(r)}</strong>\n                </div>\n                <div class="progress">\n  <div class="range" style="max-width: ${r>=100?100:r}%;"></div>\n</div>\n\n                </div>\n        <div class="summary-card">\n                    <i class=""></i>\n                     <div>\n                <p>\n        Products Listed:</p> <strong class="contain-number" >${t.length}</strong>\n        </div>\n           <div class="progress">\n  <div class="range" style="max-width: ${t.length>=100?100:t.length}%;"></div>\n</div>\n        </div>\n        <div class="summary-card">\n           <i class=""></i> <div>\n     <p>Available Balance:</p> <strong class="contain-number">â‚¦${fn(o)}</strong>\n     </div>\n     </div>\n        ${o>0?`\n          <div class="summary-card" style="border-color: #0a6;">\n             <i class=""></i>\n                     <div>\n                <p>\n            <small class="contain-number">You can withdraw up to â‚¦${fn(o)}</small></p>\n            </div>\n          </div>\n        `:""}\n      `);const i=document.getElementById("summary-sales"),l=document.getElementById("wallet-earnings"),c=document.getElementById("summary-earnings");i&&(i.textContent="â‚¦"+fn(n||0)),c&&(c.textContent="â‚¦"+fn(o)),l&&(l.textContent="â‚¦"+fn(o))}catch(e){console.error("Error in loadSalesSummary:",e);const t=document.querySelector(".sales-stats");t&&(t.innerHTML="<p>Error loading sales data</p>")}animetNum()}}async function initializeCharts(){if(!await getUser())return;const e=await fetchChartData(),t=document.getElementById("salesChart").getContext("2d");window.mainChart=new Chart(t,{type:"line",data:{labels:e.dates,datasets:[{label:"Sales (â‚¦)",data:e.sales,borderColor:"rgba(0, 170, 255, 1)",backgroundColor:"rgba(0, 170, 255, 0.1)",borderWidth:3,fill:!0,tension:.4,pointBackgroundColor:"rgba(0, 170, 255, 1)",pointBorderColor:"#fff",pointBorderWidth:2,pointRadius:5,pointHoverRadius:8},{label:"Earnings (â‚¦)",data:e.earnings,borderColor:"rgba(102, 0, 255, 1)",backgroundColor:"rgba(102, 0, 255, 0.1)",borderWidth:3,fill:!0,tension:.4,borderDash:[5,5],pointBackgroundColor:"rgba(102, 0, 255, 1)",pointBorderColor:"#fff",pointBorderWidth:2,pointRadius:5,pointHoverRadius:8}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top",labels:{color:"var(--text-light)",padding:20,font:{size:13,family:"sans-serif"},usePointStyle:!0}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.8)",titleColor:"#fff",bodyColor:"#fff",borderColor:"rgba(255, 255, 255, 0.2)",borderWidth:1,padding:12,cornerRadius:8,displayColors:!0,callbacks:{label:function(e){return`${e.dataset.label}: â‚¦${e.parsed.y.toLocaleString()}`}}}},scales:{x:{grid:{color:"var(--chart-grid)",drawBorder:!1},ticks:{color:"var(--chart-text)",maxRotation:45}},y:{beginAtZero:!0,grid:{color:"var(--chart-grid)",drawBorder:!1},ticks:{color:"var(--chart-text)",callback:function(e){return"â‚¦"+e.toLocaleString()}}}},interaction:{intersect:!1,mode:"index"},animations:{tension:{duration:1e3,easing:"linear"}}}});const a=document.getElementById("engagementChart").getContext("2d");window.engagementChart=new Chart(a,{type:"doughnut",data:{labels:["Likes","Shares","Views"],datasets:[{data:e.engagement,backgroundColor:["rgba(0, 170, 255, 0.8)","rgba(102, 0, 255, 0.8)","rgba(255, 99, 132, 0.8)"],borderColor:["rgba(255, 255, 255, 0.3)","rgba(255, 255, 255, 0.3)","rgba(255, 255, 255, 0.3)"],borderWidth:2,hoverOffset:15}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{color:"var(--text-light)",padding:15}},tooltip:{callbacks:{label:function(e){const t=e.dataset.data.reduce(((e,t)=>e+t),0),a=Math.round(e.parsed/t*100);return`${e.label}: ${e.parsed} (${a}%)`}}}},cutout:"70%"}});const n=document.getElementById("productsChart").getContext("2d");window.productsChart=new Chart(n,{type:"bar",data:{labels:e.topProducts.names,datasets:[{label:"Sales",data:e.topProducts.sales,backgroundColor:"rgba(0, 170, 255, 0.8)",borderColor:"rgba(0, 170, 255, 1)",borderWidth:1,borderRadius:6,borderSkipped:!1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{grid:{display:!1},ticks:{color:"var(--chart-text)",maxRotation:45}},y:{beginAtZero:!0,grid:{color:"var(--chart-grid)"},ticks:{color:"var(--chart-text)"}}}}}),updateChartStats(e)}async function fetchChartData(e=30){const t=await getUser();if(!t)return getDefaultChartData();try{const{data:a,error:n}=await supabase.from("posts").select("*").eq("user_id",t.id);if(n)throw n;console.log("Posts data:",a);const r=generateDates(e);let o=0,s=0,i=0;a&&a.length>0&&a.forEach((e=>{const t=(e.sales||0)*(e.price||0);o+=t,s+=.7*t,i+=e.sales||0})),console.log("Total sales:",o);const l=new Array(e).fill(0),c=new Array(e).fill(0);if(o>0){const t=Math.floor(e/2);for(let a=0;a<e;a++){const n=Math.abs(a-t),r=Math.max(0,1-n/t*.7);l[a]=o/e*r*1.5,c[a]=.7*l[a]}}const d=(await Promise.all((a||[]).map((e=>initStar(e.id))))).reduce(((e,t)=>e+t),0),u=25*a?.length||0;console.log("Stars:",d,"Views:",u);const m=[d||5,i||2,u||50],p=(a||[]).sort(((e,t)=>(t.sales||0)-(e.sales||0))).slice(0,5),g={names:p.map((e=>e.name.substring(0,15)+(e.name.length>15?"...":""))),sales:p.map((e=>e.sales||0))};return console.log("Top products:",g),a&&0!==a.length&&0!==o?{dates:r,sales:l,earnings:c,engagement:m,topProducts:g}:(console.log("No data - showing demo"),{dates:r,sales:r.map((()=>100*Math.random()+20)),earnings:r.map((()=>70*Math.random()+10)),engagement:[15,5,100],topProducts:{names:["Demo Product 1","Demo Product 2","Demo Product 3"],sales:[0,0,0]}})}catch(e){return console.error("Error fetching chart data:",e),getDefaultChartData()}}async function updateChartStats(e){const t=e.sales.reduce(((e,t)=>e+t),0),a=Math.max(...e.sales),n=e.sales.indexOf(a);let r=0;if(e.sales.length>=14){const t=e.sales.slice(0,7).reduce(((e,t)=>e+t),0),a=e.sales.slice(-7).reduce(((e,t)=>e+t),0);t>0&&(r=((a-t)/t*100).toFixed(1))}const o=document.getElementById("avgSales"),s=document.getElementById("peakDay"),i=document.getElementById("growthRate");if(o&&(o.textContent=t>0?`â‚¦${t.toLocaleString(void 0,{maximumFractionDigits:0})}`:"â‚¦0"),s&&(s.textContent=a>0?e.dates[n]:"No sales yet"),i){const e=r||"0.0";i.textContent=`${e}%`,parseFloat(r)>0?i.style.color="#0c6":parseFloat(r)<0?i.style.color="#f55":i.style.color="var(--text-light)"}}async function generateDates(e){const t=[];for(let a=e-1;a>=0;a--){const e=new Date;e.setDate(e.getDate()-a),t.push(e.toLocaleDateString("en-US",{month:"short",day:"numeric"}))}return t}async function getDefaultChartData(){const e=generateDates(30);return{dates:e,sales:e.map((()=>0)),earnings:e.map((()=>0)),engagement:[0,0,0],topProducts:{names:[],sales:[]}}}function setupChartControls(){const e=document.getElementById("timeRange"),t=document.getElementById("refreshChart");e?.addEventListener("change",(async function(){const e=parseInt(this.value),t=await fetchChartData(e);window.mainChart.data.labels=t.dates,window.mainChart.data.datasets[0].data=t.sales,window.mainChart.data.datasets[1].data=t.earnings,window.mainChart.update(),updateChartStats(t)})),t?.addEventListener("click",(async function(){this.classList.add("refreshing");const e=parseInt(document.getElementById("timeRange").value),t=await fetchChartData(e);window.mainChart.data.labels=t.dates,window.mainChart.data.datasets[0].data=t.sales,window.mainChart.data.datasets[1].data=t.earnings,window.mainChart.update(),window.engagementChart.data.datasets[0].data=t.engagement,window.engagementChart.update(),window.productsChart.data.labels=t.topProducts.names,window.productsChart.data.datasets[0].data=t.topProducts.sales,window.productsChart.update(),updateChartStats(t),setTimeout((()=>{this.classList.remove("refreshing"),cAlert("Charts refreshed successfully!","success")}),1e3)}))}async function renderPerformanceChart(){const e=await getUser();if(!e)return;const{data:t,error:a}=await supabase.from("posts").select("id, name, sales, star").eq("user_id",e.id);if(a)return void console.error("Chart load error:",a);const n=await Promise.all(t.map((e=>initStar(e.id)))),r=t.map((e=>e.name)),o=t.map((e=>e.sales||0)),s=document.getElementById("salesChart");if(!s)return;const i=s.getContext("2d");window.performanceChart&&window.performanceChart.destroy(),window.performanceChart=new Chart(i,{type:"bar",data:{labels:r,datasets:[{label:"Sales",data:o,backgroundColor:"rgba(54, 162, 235, 0.6)"},{label:"Likes",data:n,backgroundColor:"rgba(255, 206, 86, 0.6)"}]},options:{responsive:!0,plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!0}}}})}async function getAvailableBalance(){const e=await getUser();if(!e)return 0;try{const{data:t,error:a}=await supabase.from("posts").select("price, sales").eq("user_id",e.id);if(a)return console.error("Error loading posts data for earnings:",a),0;const n=t.reduce(((e,t)=>{const a=t.sales||0;return e+.7*((t.price||0)*a)}),0),{data:r,error:o}=await supabase.from("withdraw_requests").select("amount, status").eq("user_id",e.id).in("status",["approved","paid"]);if(o)return console.error("Error loading withdraws:",o),0;const s=n-r.reduce(((e,t)=>e+(t.amount||0)),0);return Math.max(s,0)}catch(e){return console.error("Error in getAvailableBalance:",e),0}}async function requestWithdraw(e,t){const a=await getUser();if(!a)return;const n=await getAvailableBalance();if(e>n)return cAlert(`You can only withdraw up to â‚¦${fn(n)}`,"warning");const{error:r}=await supabase.from("withdraw_requests").insert({user_id:a.id,amount:e,bank_details:t,status:"pending"});if(r)return console.error("Withdraw request failed:",r),void cAlert("Withdraw request failed. Please try again.","warning","Failed");cAlert("Withdraw request submitted for review!"),document.getElementById("withdrawForm").reset()}notificationForm&&notificationForm.addEventListener("submit",(async e=>{e.preventDefault(),cAlert("Notification preferences saved!","success")})),withdrawForm&&withdrawForm.addEventListener("submit",(async e=>{e.preventDefault();const t=parseFloat(document.getElementById("requestAmt").value),a=document.getElementById("bankName").value.trim(),n=document.getElementById("accountName").value.trim(),r=document.getElementById("accountNumber").value.trim(),o=document.getElementById("extraNote").value.trim();if(!a||!n||!r)return void cAlert("Please fill in all required bank details.");if(10!==r.length||isNaN(r))return void cAlert("Please enter a valid 10-digit account number.");const s=`Bank: ${a} | Account Name: ${n} | Account No: ${r}${o?" | Note: "+o:""}`;await requestWithdraw(t,s)}));const deleteAccountBtn=document.getElementById("deleteAccountBtn");deleteAccountBtn&&deleteAccountBtn.addEventListener("click",(async()=>{if(confirm("Are you sure you want to delete your account? This action cannot be undone."))try{const{data:{user:e},error:t}=await supabase.auth.getUser();if(t)throw t;if(!e)throw new Error("No user found. Please log in again.");const a=e.id,n=await fetch("/.netlify/functions/deleteUser",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:a})}),r=await n.json();if(!n.ok)throw new Error(r.message);cAlert("Account deleted successfully.","success","Deleted"),window.location.href="/"}catch(e){cAlert("Error deleting account: "+e.message,"warning","Error")}}));const nGrid=document.querySelector(".notify-grid");async function loadNotifications(){const e=await getUser();if(!e)return;const{data:t,error:a}=await supabase.from("notify").select("*").or(`user_id.eq.${e.id},user_id.is.null`).order("created_at",{ascending:!1});if(a)return console.error(a),void(nGrid.innerHTML='<p class="notify-error">Failed to load notifications.</p>');nGrid.innerHTML=t.map((e=>`\n      <div class="notify-card ${e.type}">\n        <div class="notify-text">${e.text}</div>\n        <span class="notify-time">${new Date(e.created_at).toLocaleString()}</span>\n      </div>\n    `)).join("")}async function checkDashboardProgress(){const e=await getUser();if(!e)return;const t={checkProfile:!1,checkFirstTemplate:!1,checkBankDetails:!1,checkFiveTemplates:!1,checkFirstSale:!1,checkWithdraw:!1};try{const{data:a}=await supabase.from("profiles").select("bio, photo_url, skills").eq("id",e.id).single();if(a){const e=a.bio&&a.bio.length>20,n=a.photo_url&&"/assets/images/default.png"!==a.photo_url,r=a.skills&&""!==a.skills;t.checkProfile=e&&n&&r}const{data:n}=await supabase.from("posts").select("id, sales").eq("user_id",e.id);n&&(t.checkFirstTemplate=n.length>0,t.checkFiveTemplates=n.length>=5,t.checkFirstSale=n.some((e=>e.sales>0)));const{data:r}=await supabase.from("withdraw_requests").select("bank_details").eq("user_id",e.id).limit(1);t.checkBankDetails=r&&r.length>0;const o=await getAvailableBalance();t.checkWithdraw=o>=18e3,Object.keys(t).forEach((e=>{const a=document.getElementById(e);a&&(t[e]?(a.classList.add("completed"),a.querySelector("i").className="fas fa-check-circle"):(a.classList.remove("completed"),a.querySelector("i").className="far fa-circle"))}));const s=Object.values(t).filter(Boolean).length,i=Object.keys(t).length;cAlert(`You've completed ${s} out of ${i} checklist items! ${s>=3?"Great progress!":"Keep going!"}`,s>=3?"success":"info","Progress Check")}catch(e){console.error("Progress check error:",e),cAlert("Could not check progress. Please try again.","warning","Error")}}async function setUpRew(){const e=await getUser();if(!e)return;const t=document.getElementById("rewWithdrawBtn"),a=document.getElementById("rewCopyBtn"),n=document.getElementById("rewRefLink"),r=document.getElementById("rewBalanceAmount"),o=document.getElementById("rewNotification"),s=document.getElementById("rewWithdrawalModal"),i=document.getElementById("rewCloseModal"),l=document.getElementById("rewCancelBtn"),c=document.getElementById("rewSubmitWithdrawal"),d=document.getElementById("rewWithdrawAmount"),u=document.getElementById("rewWithdrawalForm"),m=document.getElementById("rewCountry"),p=document.getElementById("rewBankName"),g=document.getElementById("rewAccountName"),h=document.getElementById("rewAccountNumber"),f=document.getElementById("rewAddress"),w=document.getElementById("rewNotes");n.value="https://devtem.org/home?rew="+e.id;const{data:y}=await supabase.from("profiles").select("rew").eq("id",e.id).single(),v=fn(y.rew);function b(e,t=!1){o.textContent=e,o.classList.toggle("error",t),o.classList.add("show"),setTimeout((()=>{o.classList.remove("show")}),3e3)}function k(e){return parseFloat(e.replace(/[â‚¦,]/g,""))}function C(){s.classList.remove("active"),document.body.style.overflow="",u.reset(),document.querySelectorAll(".rew-form-input, .rew-form-select").forEach((e=>{e.classList.remove("error")})),document.querySelectorAll(".rew-error-message").forEach((e=>{e.classList.remove("show")}))}r.textContent=`â‚¦${v||0}`,a.addEventListener("click",(()=>{n.select(),n.setSelectionRange(0,99999),navigator.clipboard.writeText(n.value).then((()=>{a.textContent="Copied!",a.classList.add("copied"),b("Referral link copied to clipboard!"),setTimeout((()=>{a.textContent="Copy",a.classList.remove("copied")}),2e3)})).catch((e=>{b("Failed to copy link",!0),console.error("Copy failed:",e)}))})),t.addEventListener("click",(e=>{e.preventDefault();const t=k(r.textContent);if(t>=1e4)d.textContent=r.textContent,s.classList.add("active"),document.body.style.overflow="hidden";else{b(`Minimum withdrawal is â‚¦10,000. You need â‚¦${fn(1e4-t)} more.`,!0)}})),i.addEventListener("click",C),l.addEventListener("click",C),s.addEventListener("click",(e=>{e.target===s&&C()})),c.addEventListener("click",(t=>{if(t.preventDefault(),!function(){let e=!0;return m.value?(m.classList.remove("error"),document.getElementById("rewCountryError").classList.remove("show")):(m.classList.add("error"),document.getElementById("rewCountryError").classList.add("show"),e=!1),p.value.trim()?(p.classList.remove("error"),document.getElementById("rewBankNameError").classList.remove("show")):(p.classList.add("error"),document.getElementById("rewBankNameError").classList.add("show"),e=!1),g.value.trim()?(g.classList.remove("error"),document.getElementById("rewAccountNameError").classList.remove("show")):(g.classList.add("error"),document.getElementById("rewAccountNameError").classList.add("show"),e=!1),!h.value.trim()||h.value.trim().length<10?(h.classList.add("error"),document.getElementById("rewAccountNumberError").classList.add("show"),e=!1):(h.classList.remove("error"),document.getElementById("rewAccountNumberError").classList.remove("show")),e}())return void b("Please fill in all required fields",!0);const a=k(r.textContent),n=e.id,o=new FormData;o.append("user_id",n),o.append("reward_balance",a),o.append("country",m.value),o.append("bank_name",p.value),o.append("account_name",g.value),o.append("account_number",h.value),o.append("address",f.value),o.append("notes",w.value),o.append("withdrawal_request","true"),c.disabled=!0,c.textContent="Processing...",fetch("https://formspree.io/f/xqadrken",{method:"POST",body:o,headers:{Accept:"application/json"}}).then((e=>{if(!e.ok)throw new Error("Submission failed");b("Withdrawal request submitted successfully!"),C()})).catch((e=>{b("Failed to submit withdrawal request. Please try again.",!0),console.error("Error:",e)})).finally((()=>{c.disabled=!1,c.textContent="Submit Withdrawal"}))})),window.rewCheckBalance=function(){k(r.textContent)<1e4&&(t.title="Minimum withdrawal is â‚¦10,000",t.disabled=!0)},rewCheckBalance()}async function payYearly(){const e=await getUser();if(!e)return;PaystackPop.setup({key:"pk_live_0b0770be1e29f5e7a159b39d2d9bdc2c41785306",email:e.email,amount:4692e3,currency:"NGN",ref:"DT_"+Date.now(),callback:function(t){fetch(""+(`${nT[16]}.${nT[0]}`+nT[2]+nT[4]+nT[16]+nT[6]+nT[9]+nT[15]+nT[16]+nT[19]+nT[21]),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reference:t.reference,user_id:e.id})}).then((e=>e.json())).then((e=>{e.success?(cAlert("Payment verified! You are now Pro","success"),location.href="#/user/"):cAlert("Payment verification failed")}))}}).openIframe()}window.fn=function(e){return e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})},document.querySelector(".checklist-btn").addEventListener("click",(e=>{checkDashboardProgress()})),document.querySelector("#premiumPayYearlyBtn").addEventListener("click",(async e=>await payYearly())),window.addEventListener("load",(async()=>{const e=await getUser();if(!e)return;const{data:t}=await supabase.from("profiles").select("status, verified_at").eq("id",e.id).single();if("verified"!==t?.status)return;if(!t.verified_at)return;const a=new Date(t.verified_at).getTime();Date.now()-a>31536e6&&(await fetch(""+(`${nT[16]}.${nT[0]}`+nT[2]+nT[4]+nT[16]+nT[6]+nT[9]+nT[15]+nT[16]+nT[17]+nT[18]+nT[22]+nT[20]),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:e.id})}),cAlert("Your Pro plan has expired."),location.href="#/premium/")})),window.addEventListener("DOMContentLoaded",(()=>{loadProfile(),loadPosts(),loadSalesSummary(),renderPerformanceChart(),loadNotifications(),initializeCharts(),setupChartControls(),setUpRew()}));
