import{createClient}from"https://esm.sh/@supabase/supabase-js@2";import{unw}from"./unw3bbd34z.js";function formatLength(e){const t=200-e.length;return t>=1?e+="&nbsp ".repeat(t):e}let authBio="creator",authImg="/assets/images/default.png",authName="creator",authSkill="creator",portfolioUrl=" ",authFname="creator",authStatus="pending";const{url:url,key:key}={url:td,key:tc};export const supabase=createClient(url,key);async function getUser(){const{data:e,error:t}=await supabase.auth.getUser();return t?(console.error("Auth error:",t),null):e?.user||null}async function signOut(){await supabase.auth.signOut(),window.location.href="/signup.html"}async function loadProfile(){const e=await getUser();if(!e)return void(window.location.href="/signup.html");document.querySelector(".user .email").textContent=e.email,document.querySelector(".user .uid").textContent=e.id;const t=new Date(e.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});document.querySelector(".join-date").textContent=t;const r=new Date(e.last_sign_in_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});document.querySelector(".last-login").textContent=r;const{data:a}=await supabase.from("profiles").select("*").eq("id",e.id).single();a&&(document.querySelector("#account-status").textContent=a.status,document.querySelector(".status").style.color="pending"===document.querySelector("#account-status").textContent?"#960":"#096",document.getElementById("userName").value=a.username?.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")||"",document.getElementById("top-username").textContent=a.username?.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")||"",document.getElementById("fullName").value=a.full_name?.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")||"",document.getElementById("email").value=e.email,document.getElementById("phone").value=a.phone||"",document.getElementById("bio").value=a.bio?.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")||"",document.getElementById("preview-bio").textContent=a.bio?.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")||"",document.getElementById("skill").value=a.skills||"",document.getElementById("portfolio").value=a.portfolio_url||"",document.querySelector(".user.img").src=a.photo_url||"/assets/images/default.png",document.getElementById("profileName").textContent=a.full_name?.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")||a.username||"User",document.getElementById("profileSkill").textContent=a.skills||"No skill set",document.getElementById("profileName").innerHTML+=` <sup style="font-size: 0.6em;-webkit-text-stroke: 0.2px #0f9;">${"verified"===a.status?'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="14" height="14" viewBox="0 0 256 256" xml:space="preserve">\n<g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">\n\t<path d="M 49.66 1.125 L 49.66 1.125 c 4.67 -2.393 10.394 -0.859 13.243 3.548 l 0 0 c 1.784 2.761 4.788 4.495 8.071 4.66 l 0 0 c 5.241 0.263 9.431 4.453 9.694 9.694 v 0 c 0.165 3.283 1.899 6.286 4.66 8.071 l 0 0 c 4.407 2.848 5.941 8.572 3.548 13.242 l 0 0 c -1.499 2.926 -1.499 6.394 0 9.319 l 0 0 c 2.393 4.67 0.859 10.394 -3.548 13.242 l 0 0 c -2.761 1.784 -4.495 4.788 -4.66 8.071 v 0 c -0.263 5.241 -4.453 9.431 -9.694 9.694 h 0 c -3.283 0.165 -6.286 1.899 -8.071 4.66 l 0 0 c -2.848 4.407 -8.572 5.941 -13.242 3.548 l 0 0 c -2.926 -1.499 -6.394 -1.499 -9.319 0 l 0 0 c -4.67 2.393 -10.394 0.859 -13.242 -3.548 l 0 0 c -1.784 -2.761 -4.788 -4.495 -8.071 -4.66 h 0 c -5.241 -0.263 -9.431 -4.453 -9.694 -9.694 l 0 0 c -0.165 -3.283 -1.899 -6.286 -4.66 -8.071 l 0 0 C 0.266 60.054 -1.267 54.33 1.125 49.66 l 0 0 c 1.499 -2.926 1.499 -6.394 0 -9.319 l 0 0 c -2.393 -4.67 -0.859 -10.394 3.548 -13.242 l 0 0 c 2.761 -1.784 4.495 -4.788 4.66 -8.071 l 0 0 c 0.263 -5.241 4.453 -9.431 9.694 -9.694 l 0 0 c 3.283 -0.165 6.286 -1.899 8.071 -4.66 l 0 0 c 2.848 -4.407 8.572 -5.941 13.242 -3.548 l 0 0 C 43.266 2.624 46.734 2.624 49.66 1.125 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: var(--primary-color); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round"/>\n\t<polygon points="36.94,66.3 36.94,66.3 36.94,46.9 36.94,46.9 62.8,35.34 72.5,45.04 " style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: var(--primary-color); fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>\n\t<polygon points="36.94,66.3 17.5,46.87 27.2,37.16 36.94,46.9 60.11,23.7 69.81,33.39 " style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>\n</g>\n</svg>':""}</sup>`,authBio=a.bio||"",authImg=a.photo_url||"/assets/images/default.png",authName=a.username||"",authSkill=a.skills||"",authStatus=a.status||"",authFname=a.full_name||"",portfolioUrl=a.portfolio_url||"",updateBioCharCount()),await loadProfileStats()}function updateBioCharCount(){const e=document.getElementById("bio"),t=document.getElementById("bioCharCount");e&&t&&(t.textContent=e.value.length,e.addEventListener("input",(()=>{t.textContent=e.value.length})))}async function loadProfileStats(){const e=await getUser();if(!e)return;const{data:t}=await supabase.from("posts").select("sales, price").eq("user_id",e.id);if(t){const e=t.length,r=t.reduce(((e,t)=>e+(t.sales||0)),0),a=t.reduce(((e,t)=>e+(t.price||0)*(t.sales||0)),0);document.getElementById("statUploads").textContent=e,document.getElementById("summary-uploads").textContent=e,document.getElementById("statSales").textContent=r,document.getElementById("statEarnings").onclick=()=>{cAlert(`‚Ç¶${fn(a||0)}`,"success","Total earnings")}}}document.getElementById("logoutBtn").onclick=signOut;const zipInput=document.getElementById("zipInput"),filename=document.querySelector(".file-name");zipInput&&(zipInput.onchange=()=>{filename&&(filename.textContent=zipInput.files[0]?.name||"")});const publisherForm=document.getElementById("publisherForm");async function initStar(e){try{const{count:t,error:r}=await supabase.from("stars").select("*",{count:"exact",head:!0}).eq("post_id",e);if(r)throw r;return t||0}catch(e){return console.error("Star init failed:",e),0}}async function deletePost(e){if(confirm(`Delete "${e.name}"? This cannot be undone.`))try{const{error:t}=await supabase.from("stars").delete().eq("post_id",e.id);if(t)return console.error("SDB delete error:",t),void cAlert("‚ùåFailed to delete related stars.","warning","Error");if(e.file_path){const{error:t}=await supabase.storage.from("uploads").remove([e.file_path]);if(t)return console.error("Storage delete error:",t),void cAlert("‚ùåFailed to delete file from storage.","warning","Failed")}const{error:r}=await supabase.from("posts").delete().eq("id",e.id);if(r)return console.error("DB delete error:",r),void cAlert("‚ùåFailed to delete post from Database.","warning","Failed");cAlert("Post deleted!","success","Deleted"),loadPosts(),loadSalesSummary(),loadSalesChart(),renderPerformanceChart()}catch(e){console.error("Unexpected error:",e),cAlert("‚ùåAn unexpected error occurred.","warning","Error")}}async function loadPosts(){try{const e=await getUser();if(!e)return void console.warn("No logged-in user found.");const{data:t,error:r}=await supabase.from("posts").select("id, name, description, price, cover, auth_bio, auth_img, auth_name, star, sales, auth_skill, portfolio_url, auth_fname, auth_status, sponsored, created_at").eq("user_id",e.id).order("created_at",{ascending:!1});if(r)throw r;const a=document.querySelector(".product-grid");if(!a)return;if(a.innerHTML="",!t||0===t.length)return void(a.innerHTML='<p class="empty-msg">You haven\'t uploaded any posts yet.\n      <br/>\n      <a href="#/pen/">\n      <svg viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="#000000" style="opacity: 0.7;"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M512 301.2m-10 0a10 10 0 1 0 20 0 10 10 0 1 0-20 0Z" fill="#E73B37"></path><path d="M400.3 744.5c2.1-0.7 4.1-1.4 6.2-2-2 0.6-4.1 1.3-6.2 2z m0 0c2.1-0.7 4.1-1.4 6.2-2-2 0.6-4.1 1.3-6.2 2z" fill="#39393A"></path><path d="M511.8 256.6c24.4 0 44.2 19.8 44.2 44.2S536.2 345 511.8 345s-44.2-19.8-44.2-44.2 19.9-44.2 44.2-44.2m0-20c-35.5 0-64.2 28.7-64.2 64.2s28.7 64.2 64.2 64.2 64.2-28.7 64.2-64.2-28.7-64.2-64.2-64.2z" fill="#E73B37"></path><path d="M730.7 529.5c0.4-8.7 0.6-17.4 0.6-26.2 0-179.6-86.1-339.1-219.3-439.5-133.1 100.4-219.2 259.9-219.2 439.5 0 8.8 0.2 17.5 0.6 26.1-56 56-90.6 133.3-90.6 218.7 0 61.7 18 119.1 49.1 167.3 30.3-49.8 74.7-90.1 127.7-115.3 39-18.6 82.7-29 128.8-29 48.3 0 93.9 11.4 134.3 31.7 52.5 26.3 96.3 67.7 125.6 118.4 33.4-49.4 52.9-108.9 52.9-173.1 0-85.4-34.6-162.6-90.5-218.6zM351.1 383.4c9.2-37.9 22.9-74.7 40.6-109.5a502.1 502.1 0 0 1 63.6-95.9c17.4-20.6 36.4-39.9 56.8-57.5 20.4 17.6 39.4 36.9 56.8 57.5 24.8 29.5 46.2 61.8 63.6 95.9 17.7 34.8 31.4 71.6 40.6 109.5 8.7 35.8 13.5 72.7 14.2 109.9C637.4 459 577 438.9 512 438.9c-65 0-125.3 20.1-175.1 54.4 0.7-37.2 5.5-74.1 14.2-109.9z m-90.6 449.2c-9.1-27-13.7-55.5-13.7-84.4 0-35.8 7-70.6 20.8-103.2 8.4-19.8 19-38.4 31.9-55.5 9.7 61.5 29.5 119.7 57.8 172.6-36.4 17.8-69 41.6-96.8 70.5z m364.2-85.3c-0.7-0.3-1.5-0.5-2.2-0.8-0.4-0.2-0.9-0.3-1.3-0.5-0.6-0.2-1.3-0.5-1.9-0.7-0.8-0.3-1.5-0.5-2.3-0.8-0.8-0.3-1.5-0.5-2.3-0.7l-0.9-0.3c-1-0.3-2.1-0.7-3.1-1-1.2-0.4-2.4-0.7-3.5-1.1l-3-0.9c-0.2-0.1-0.4-0.1-0.7-0.2-1.1-0.3-2.3-0.7-3.4-1-1.2-0.3-2.4-0.6-3.5-0.9l-3.6-0.9-3.6-0.9c-1-0.3-2.1-0.5-3.1-0.7-1.2-0.3-2.4-0.5-3.6-0.8-1.3-0.3-2.5-0.6-3.8-0.8h-0.3c-0.9-0.2-1.9-0.4-2.8-0.6-0.4-0.1-0.7-0.1-1.1-0.2-1.1-0.2-2.2-0.4-3.4-0.6-1.2-0.2-2.4-0.4-3.6-0.7l-5.4-0.9c-0.9-0.1-1.9-0.3-2.8-0.4-0.8-0.1-1.6-0.3-2.5-0.4-2.6-0.4-5.1-0.7-7.7-1-1.2-0.1-2.3-0.3-3.5-0.4h-0.4c-0.9-0.1-1.8-0.2-2.8-0.3-1.1-0.1-2.1-0.2-3.2-0.3-1.7-0.2-3.4-0.3-5.1-0.4-0.8-0.1-1.5-0.1-2.3-0.2-0.9-0.1-1.9-0.1-2.8-0.2-0.4 0-0.8 0-1.2-0.1-1.1-0.1-2.1-0.1-3.2-0.2-0.5 0-1-0.1-1.5-0.1-1.3-0.1-2.6-0.1-3.9-0.1-0.8 0-1.5-0.1-2.3-0.1-1.2 0-2.4 0-3.5-0.1h-13.9c-2.3 0-4.6 0.1-6.9 0.2-0.9 0-1.9 0.1-2.8 0.1-0.8 0-1.5 0.1-2.3 0.1-1.4 0.1-2.8 0.2-4.1 0.3-1.4 0.1-2.7 0.2-4.1 0.3-1.4 0.1-2.7 0.2-4.1 0.4-0.6 0-1.2 0.1-1.8 0.2l-7.8 0.9c-1.1 0.1-2.1 0.3-3.2 0.4-1 0.1-2.1 0.3-3.1 0.4-3.2 0.5-6.4 0.9-9.5 1.5-0.7 0.1-1.4 0.2-2.1 0.4-0.9 0.1-1.7 0.3-2.6 0.5-1.1 0.2-2.3 0.4-3.4 0.6-0.9 0.2-1.7 0.3-2.6 0.5-0.4 0.1-0.8 0.1-1.1 0.2-0.7 0.1-1.4 0.3-2.1 0.4-1.2 0.3-2.4 0.5-3.6 0.8-1.2 0.3-2.4 0.5-3.6 0.8-0.2 0-0.4 0.1-0.6 0.1-0.5 0.1-1 0.2-1.5 0.4-1.1 0.3-2.3 0.6-3.5 0.9-1.3 0.3-2.5 0.6-3.8 1-0.4 0.1-0.9 0.2-1.4 0.4-1.3 0.4-2.7 0.7-4 1.1-1.5 0.4-3 0.9-4.6 1.3-1 0.3-2.1 0.6-3.1 1-2.1 0.6-4.1 1.3-6.2 2-0.7 0.2-1.4 0.5-2.1 0.7-15-27.5-27.4-56.4-37-86.2-11.7-36.1-19.2-73.6-22.5-111.6-0.6-6.7-1-13.3-1.3-20-0.1-1.2-0.1-2.4-0.1-3.6-0.1-1.2-0.1-2.4-0.1-3.6 0-1.2-0.1-2.4-0.1-3.6 0-1.2-0.1-2.4-0.1-3.7 18.8-14 39.2-25.8 61-35 36.1-15.3 74.5-23 114.1-23 39.6 0 78 7.8 114.1 23 21.8 9.2 42.2 20.9 61 35v0.1c0 1 0 1.9-0.1 2.9 0 1.4-0.1 2.8-0.1 4.3 0 0.7 0 1.3-0.1 2-0.1 1.8-0.1 3.5-0.2 5.3-0.3 6.7-0.8 13.3-1.3 20-3.3 38.5-11 76.5-23 113-9.7 30.3-22.3 59.4-37.6 87.1z m136.8 90.9a342.27 342.27 0 0 0-96.3-73.2c29.1-53.7 49.5-112.8 59.4-175.5 12.8 17.1 23.4 35.6 31.8 55.5 13.8 32.7 20.8 67.4 20.8 103.2 0 31-5.3 61.3-15.7 90z" fill="#39393A"></path><path d="M512 819.3c8.7 0 24.7 22.9 24.7 60.4s-16 60.4-24.7 60.4-24.7-22.9-24.7-60.4 16-60.4 24.7-60.4m0-20c-24.7 0-44.7 36-44.7 80.4 0 44.4 20 80.4 44.7 80.4s44.7-36 44.7-80.4c0-44.4-20-80.4-44.7-80.4z" fill="#E73B37"></path></g></svg>\n      <h4><I class="fas fa-plus"></i> Start selling</h4>\n      </a>\n      </p>\n      ');t.forEach((e=>{const t=document.createElement("div");t.className="card",t.dataset.id=e.id,t.dataset.filePath=e.file_path,t.dataset.sellerId=e.user_id,t.dataset.profileId=e.user_id,t.innerHTML=`\n        <div class="product-img" style="background-image: url(${e.cover||"/assets/images/index.png"});">\n          <h3 class="delete-btn"><i class="fas fa-trash"></i></h3>\n          <a href="/home.html#search?q=${encodeURIComponent(e.description?.slice(0,200).replace(/\&amp\;/,"&").replace(/&gt;/,">").replace(/&lt;/,"<"))}"><h4 data-view="${e.viewer||"https://media.tenor.com/aGgnqxZUzeUAAAAM/sad.gif"}"><i class="fas fa-eye"></i></h4></a>\n        </div>\n  <p class="product-describe">\n    <strong>${e.name?.slice(0,35).replace(/</g,"&lt;").replace(/>/g,"&gt;")}${e.name.length>35?"‚Ä¶":""}  </strong><br>\n    ${formatLength(e.description?.slice(0,200).replace(/</g,"&lt;").replace(/>/g,"&gt;"))}${e.description.length>200?"‚Ä¶":""}\n  </p>\n  <input type="button" value="${new Date(e.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}">\n        <div class="profile" data-bio="${e.auth_bio||""} ‚Ä¢ ${e.auth_skill||""}">\n          <p><img src="${e.auth_img||e.cover||"/assets/images/default.png"}" alt="User_auth-profile">\n          <strong class="user-name">${e.auth_name?e.auth_name:e.name.slice(0,10).replace(/</g,"&lt;").replace(/>/g,"&gt;")}</strong></p>\n        </div>\n        <div class="buttons">\n          <span class="star-contain"> <button class="star" data-post-id="${e.id}" style="cursor: pointer; background: none; border: none; color: inherit;">\n        <svg width="23" height="23" viewBox="0 0 24 24" fill="currentColor">\n          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>\n        </svg></button><span class="star-count"></span></span> <span class="amount" data-price="${e.price||0}">‚Ç¶${fn(e.price||0)} <small><b class="sales">${e.sales?e.sales:0}</b> sold</small></span>\n          <a name="${encodeURIComponent(e.description?.slice(0,200).replace(/\&amp\;/,"&").replace(/&gt;/,">").replace(/&lt;/,"<")||"")}"><span class="star-contain"><i class="fas fa-share"></i> </span></a>\n        </div>\n      `;a.querySelectorAll(".card").forEach((e=>{e.querySelector(".product-describe");e&&e.querySelector(".buttons a").addEventListener("click",(t=>{navigator.clipboard.writeText(`https://devtem.org/home.html#search?q=${e.querySelector(".buttons a").name?.slice(0,75)||""}`),cAlert("Link copied üéâ","success","Copied")}))})),t.querySelector(".delete-btn").onclick=()=>deletePost(e),a.appendChild(t)}))}catch(e){console.error("Error loading posts:",e)}}publisherForm&&(publisherForm.onsubmit=async e=>{e.preventDefault(),document.querySelector(".sending").style.display="inline-block";const t=await getUser();if(!t)return cAlert("Please log in.");const r=zipInput.files[0];if(!r)return cAlert("Select a ZIP file","warning","Alert");if(unw().some((e=>document.getElementById("cardName").value?.toLowerCase().includes(e.toLowerCase())))||unw().some((e=>document.getElementById("cardDes").value?.toLowerCase().includes(e.toLowerCase()))))return document.querySelector(".sending").style.display="none",cAlert("can't be published, it contains content that may break our community guidelines","warning","UNW");const{data:a,error:n}=await supabase.storage.from("uploads").upload(`${t.id}/${r.name}`,r,{upsert:!0});if(n)return console.error(n),document.querySelector(".sending").style.display="none",cAlert("Upload failed.","warning","Error");const{error:o}=await supabase.from("posts").insert({user_id:t.id,name:document.getElementById("cardName").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),description:document.getElementById("cardDes").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),cover:document.getElementById("cardCover").value,viewer:document.getElementById("cardView").value,price:parseFloat(document.getElementById("cardAmount").value),file_path:a.path,star:0,sales:0,auth_bio:authBio,auth_img:authImg,auth_name:authName,auth_skill:authSkill,auth_status:authStatus,auth_fname:authFname,portfolio_url:portfolioUrl});if(o)return console.error(o),document.querySelector(".sending").style.display="none",cAlert("‚ùå Insert failed.","warning","Error");document.querySelector(".sending").style.display="none",loadPosts(),loadProfileStats(),cAlert("Upload successful!","success","Success"),showSection("posts"),publisherForm.reset()});const profileForm=document.querySelector('form[name="user edit"]');profileForm&&profileForm.addEventListener("submit",(async e=>{e.preventDefault();const t=profileForm.querySelector(".username").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").trim(),r=document.getElementById("fullName").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").trim(),a=profileForm.querySelector(".bio").value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").trim(),n=profileForm.querySelector(".skill").value,o=document.getElementById("phone").value,s=(document.getElementById("experience"),document.getElementById("portfolio").value),l=document.getElementById("imgUrl").files[0];if(unw().some((e=>t?.toLowerCase().includes(e.toLowerCase())))||unw().some((e=>a?.toLowerCase().includes(e.toLowerCase())))||unw().some((e=>r?.toLowerCase().includes(e.toLowerCase()))))return cAlert("can't be published, it contains content that may break our community guidelines","warning","UNW");if(r.length<=2||a.length<=2||t.length<=2)return cAlert("Profile update failed. Please provide complete and valid information.","warning","USER_INFO");try{const{data:{user:e},error:i}=await supabase.auth.getUser();if(i||!e)throw new Error("Not logged in");let c=null;if(l){const t=l.name.split(".").pop(),r=`avatars/${e.id}.${t}`,{error:a}=await supabase.storage.from("avatars").upload(r,l,{upsert:!0});if(a)throw a;const{data:n}=supabase.storage.from("avatars").getPublicUrl(r);c=n.publicUrl}const{error:d}=await supabase.from("profiles").update({username:t,full_name:r,bio:a,skills:n,phone:o,portfolio_url:s,...c&&{photo_url:c}}).eq("id",e.id);if(d)throw d;cAlert("Profile updated!","success","Success"),loadProfile()}catch(e){console.error("Profile update error:",e.message),cAlert("‚ùå Error updating profile: "+e.message,"warning","Error")}}));const notificationForm=document.getElementById("notificationForm");async function loadSalesSummary(){const e=await getUser();if(e){try{const{data:t,error:r}=await supabase.from("posts").select("id, price, sales, name").eq("user_id",e.id);if(r)return void console.error("Sales summary error:",r);if(!t||0===t.length){const e=document.querySelector(".sales-stats");return void(e&&(e.innerHTML="<p>No products uploaded yet.</p>"))}let a=0,n=0;t.forEach((e=>{const t=e.sales||0,r=e.price||0;a+=r*t,n+=t}));const o=await getAvailableBalance(),s=document.querySelector(".sales-stats");s&&(s.innerHTML=`\n        <div class="summary-card">\n           <i class=""></i>\n                     <div>\n                <p>Total Sales Value: </p>\n                <strong class="contain-number">‚Ç¶${fn(a)}</strong>\n                </div>\n                   <div class="progress">\n  <div class="range" style="max-width: ${a/550>=100?100:a/550}%;"></div>\n</div>\n                </div>\n        <div class="summary-card">\n           <i class=""></i>\n                     <div>\n                <p>Units Sold:</p> <strong class="contain-number">${fn(n)}</strong>\n                </div>\n                <div class="progress">\n  <div class="range" style="max-width: ${n>=100?100:n}%;"></div>\n</div>\n\n                </div>\n        <div class="summary-card">\n                    <i class=""></i>\n                     <div>\n                <p>\n        Products Listed:</p> <strong class="contain-number" >${t.length}</strong>\n        </div>\n           <div class="progress">\n  <div class="range" style="max-width: ${t.length>=100?100:t.length}%;"></div>\n</div>\n        </div>\n        <div class="summary-card">\n           <i class=""></i> <div>\n     <p>Available Balance:</p> <strong class="contain-number">‚Ç¶${fn(o)}</strong>\n     </div>\n     </div>\n        ${o>0?`\n          <div class="summary-card" style="border-color: #0a6;">\n             <i class=""></i>\n                     <div>\n                <p>\n            <small class="contain-number">You can withdraw up to ‚Ç¶${fn(o)}</small></p>\n            </div>\n          </div>\n        `:""}\n      `);const l=document.getElementById("summary-sales"),i=document.getElementById("wallet-earnings"),c=document.getElementById("summary-earnings");l&&(l.textContent="‚Ç¶"+fn(a||0)),c&&(c.textContent="‚Ç¶"+fn(o)),i&&(i.textContent="‚Ç¶"+fn(o))}catch(e){console.error("Error in loadSalesSummary:",e);const t=document.querySelector(".sales-stats");t&&(t.innerHTML="<p>Error loading sales data</p>")}animetNum()}}async function loadSalesChart(){const e=await getUser();if(!e)return;const{data:t,error:r}=await supabase.from("posts").select("id, name, sales, star").eq("user_id",e.id);if(r)return void console.error("Chart load error:",r);const a=await Promise.all(t.map((e=>initStar(e.id)))),n=document.getElementById("salesChart");if(!n)return;const o=n.getContext("2d");window.myChart&&window.myChart.destroy(),window.myChart=new Chart(o,{type:"bar",data:{labels:t.map((e=>e.name)),datasets:[{label:"Sales",data:t.map((e=>e.sales||0)),backgroundColor:"rgba(54, 162, 235, 0.6)"},{label:"Likes",data:a,backgroundColor:"rgba(255, 206, 86, 0.6)"}]},options:{responsive:!0,plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!0}}}})}async function renderPerformanceChart(){const e=await getUser();if(!e)return;const{data:t,error:r}=await supabase.from("posts").select("id, name, sales, star").eq("user_id",e.id);if(r)return void console.error("Chart load error:",r);const a=await Promise.all(t.map((e=>initStar(e.id)))),n=t.map((e=>e.name)),o=t.map((e=>e.sales||0)),s=document.getElementById("salesChart");if(!s)return;const l=s.getContext("2d");window.performanceChart&&window.performanceChart.destroy(),window.performanceChart=new Chart(l,{type:"bar",data:{labels:n,datasets:[{label:"Sales",data:o,backgroundColor:"rgba(54, 162, 235, 0.6)"},{label:"Likes",data:a,backgroundColor:"rgba(255, 206, 86, 0.6)"}]},options:{responsive:!0,plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!0}}}})}async function getAvailableBalance(){const e=await getUser();if(!e)return 0;try{const{data:t,error:r}=await supabase.from("posts").select("price, sales").eq("user_id",e.id);if(r)return console.error("Error loading posts data for earnings:",r),0;const a=t.reduce(((e,t)=>{const r=t.sales||0;return e+.7*((t.price||0)*r)}),0),{data:n,error:o}=await supabase.from("withdraw_requests").select("amount, status").eq("user_id",e.id).in("status",["approved","paid"]);if(o)return console.error("Error loading withdraws:",o),0;const s=a-n.reduce(((e,t)=>e+(t.amount||0)),0);return Math.max(s,0)}catch(e){return console.error("Error in getAvailableBalance:",e),0}}async function requestWithdraw(e,t){const r=await getUser();if(!r)return;const a=await getAvailableBalance();if(e>a)return cAlert(`‚ùå You can only withdraw up to ‚Ç¶${fn(a)}`,"warning");const{error:n}=await supabase.from("withdraw_requests").insert({user_id:r.id,amount:e,bank_details:t,status:"pending"});if(n)return console.error("Withdraw request failed:",n),void cAlert("Withdraw request failed. Please try again.","warning","Failed");cAlert("Withdraw request submitted for review!"),document.getElementById("withdrawForm").reset()}notificationForm&&notificationForm.addEventListener("submit",(async e=>{e.preventDefault(),cAlert("Notification preferences saved!","success")})),withdrawForm&&withdrawForm.addEventListener("submit",(async e=>{e.preventDefault();const t=parseFloat(document.getElementById("requestAmt").value),r=document.getElementById("bankName").value.trim(),a=document.getElementById("accountName").value.trim(),n=document.getElementById("accountNumber").value.trim(),o=document.getElementById("extraNote").value.trim();if(!r||!a||!n)return void cAlert("Please fill in all required bank details.");if(10!==n.length||isNaN(n))return void cAlert("Please enter a valid 10-digit account number.");const s=`Bank: ${r} | Account Name: ${a} | Account No: ${n}${o?" | Note: "+o:""}`;await requestWithdraw(t,s)}));const deleteAccountBtn=document.getElementById("deleteAccountBtn");deleteAccountBtn&&deleteAccountBtn.addEventListener("click",(async()=>{if(confirm("Are you sure you want to delete your account? This action cannot be undone."))try{const{data:{user:e},error:t}=await supabase.auth.getUser();if(t)throw t;if(!e)throw new Error("No user found. Please log in again.");const r=e.id,a=await fetch("/.netlify/functions/deleteUser",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:r})}),n=await a.json();if(!a.ok)throw new Error(n.message);cAlert("‚úÖ Account deleted successfully.","success","Deleted"),window.location.href="/"}catch(e){cAlert("‚ùå Error deleting account: "+e.message,"warning","Error")}}));const nGrid=document.querySelector(".notify-grid");async function loadNotifications(){const e=await getUser();if(!e)return;const{data:t,error:r}=await supabase.from("notify").select("*").or(`user_id.eq.${e.id},user_id.is.null`).order("created_at",{ascending:!1});if(r)return console.error(r),void(nGrid.innerHTML='<p class="notify-error">Failed to load notifications.</p>');nGrid.innerHTML=t.map((e=>`\n      <div class="notify-card ${e.type}">\n        <div class="notify-text">${e.text}</div>\n        <span class="notify-time">${new Date(e.created_at).toLocaleString()}</span>\n      </div>\n    `)).join("")}window.fn=function(e){return e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})},window.addEventListener("DOMContentLoaded",(()=>{loadProfile(),loadPosts(),loadSalesSummary(),loadSalesChart(),renderPerformanceChart(),loadNotifications()}));
