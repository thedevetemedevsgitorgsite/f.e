import{createClient}from"@supabase/supabase-js";const supabase=createClient(process.env.PUBLIC_SUPA_URL,process.env.PUBLIC_SUPA_R_KEY);export async function handler(e){try{const{reference:r}=JSON.parse(e.body),s=await fetch(`https://api.paystack.co/transaction/verify/${r}`,{headers:{Authorization:`Bearer ${process.env.PAYSTACK_SEC_KEY}`}}),o=await s.json();if(!o.status||"success"!==o.data.status)return{statusCode:400,body:JSON.stringify({error:"Payment verification failed"})};const t=o.data,{data:a,error:n}=await supabase.from("transactions_b").select("*").eq("reference",r).single();if(n||!a)return{statusCode:404,body:JSON.stringify({error:"Transaction not found"})};await supabase.from("transactions_b").update({status:"success"}).eq("reference",r);const i=a.cart_data,c=t.customer.email;let d=[];console.log("Processing cart items:",i);for(const e of i)try{const{data:r,error:s}=await supabase.from("posts").select("sales, user_id").eq("id",e.id).single();if(s){console.error(`Error fetching post ${e.id}:`,s);continue}const o=r.user_id;if(!o){console.error(`No user_id (seller) found for post ${e.id}`);continue}console.log(`Processing item ${e.id} for seller (user_id): ${o}`);const t=(r.sales||0)+1,{error:a}=await supabase.from("posts").update({sales:t}).eq("id",e.id);a?console.error(`Error updating sales for post ${e.id}:`,a):console.log(`Updated sales for post ${e.id} to ${t}`);const{error:n}=await supabase.from("earnings").insert({seller_id:o,post_id:e.id,amount:e.price,buyer:c,created_at:(new Date).toISOString()});if(n?(console.error(`Error creating earnings record for post ${e.id}:`,n),console.error("Earnings error details:",n)):console.log(`âœ… Created earnings record for post ${e.id}, seller ${o}, amount ${e.price}`),e.filePath){const{data:r,error:s}=await supabase.storage.from("uploads").createSignedUrl(e.filePath,86400);s?console.error(`Error creating signed URL for ${e.filePath}:`,s):r?.signedUrl&&d.push({id:e.id,title:e.title,url:r.signedUrl})}}catch(r){console.error(`Error processing cart item ${e.id}:`,r)}return console.log("Completed processing. Download links:",d.length),{statusCode:200,body:JSON.stringify({success:!0,downloadLinks:d,reference:t.reference,amount:t.amount/100,customer:c})}}catch(e){return console.error("Verify-pay overall error:",e),{statusCode:500,body:JSON.stringify({error:e.message})}}}
