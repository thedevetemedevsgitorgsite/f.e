import{createClient}from"@supabase/supabase-js";const supabase=createClient(process.env.PUBLIC_SUPA_URL,process.env.PUBLIC_SUPA_R_KEY);export async function handler(e){try{const{reference:r,rewId:o}=JSON.parse(e.body),s=await fetch(`https://api.paystack.co/transaction/verify/${r}`,{headers:{Authorization:`Bearer ${process.env.PAYSTACK_SEC_KEY}`}}),t=await s.json();if(!t.status||"success"!==t.data.status)return{statusCode:400,body:JSON.stringify({error:"Payment verification failed"})};const a=t.data,{data:i,error:n}=await supabase.from("transactions_b").select("*").eq("reference",r).single();if(n||!i)return{statusCode:404,body:JSON.stringify({error:"Transaction not found"})};await supabase.from("transactions_b").update({status:"success"}).eq("reference",r);const c=i.cart_data,d=a.customer.email;let l=[];console.log("Processing cart items:",c);for(const e of c)try{const{data:r,error:s}=await supabase.from("posts").select("sales, user_id").eq("id",e.id).single();if(s){console.error(`Error fetching post ${e.id}:`,s);continue}const t=r.user_id;if(!t){console.error(`No user_id (seller) found for post ${e.id}`);continue}console.log(`Processing item ${e.id} for seller (user_id): ${t}`);const a=(r.sales||0)+1,{error:i}=await supabase.from("posts").update({sales:a}).eq("id",e.id);i?console.error(`Error updating sales for post ${e.id}:`,i):console.log(`Updated sales for post ${e.id} to ${a}`);const{data:n,error:c}=await supabase.from("profiles").select("rew").eq("id",o).single();if(c)console.error(`Error fetching profile for rewId ${o}:`,c);else{const r=.07*(e.price||0),s=.1*(e.price||0),t="verified"===n.status?s+(n.rew||0):r+(n.rew||0),{error:a}=await supabase.from("profiles").update({rew:t}).eq("id",o);a?console.error(`Error updating rew for rewId ${o}:`,a):console.log(`Updated rew for profile ${o} to ${t}`)}const{error:f}=await supabase.from("earnings").insert({seller_id:t,post_id:e.id,amount:e.price,buyer:d,created_at:(new Date).toISOString()});if(f?(console.error(`Error creating earnings record for post ${e.id}:`,f),console.error("Earnings error details:",f)):console.log(`âœ… Created earnings record for post ${e.id}, seller ${t}, amount ${e.price}`),e.filePath){const{data:r,error:o}=await supabase.storage.from("uploads").createSignedUrl(e.filePath,86400);o?console.error(`Error creating signed URL for ${e.filePath}:`,o):r?.signedUrl&&l.push({id:e.id,title:e.title,url:r.signedUrl})}}catch(r){console.error(`Error processing cart item ${e.id}:`,r)}return console.log("Completed processing. Download links:",l.length),{statusCode:200,body:JSON.stringify({success:!0,downloadLinks:l,reference:a.reference,amount:a.amount/100,customer:d})}}catch(e){return console.error("Verify-pay overall error:",e),{statusCode:500,body:JSON.stringify({error:e.message})}}}
