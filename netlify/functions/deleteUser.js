import{createClient}from"@supabase/supabase-js";const supabase=createClient(process.env.PUBLIC_SUPA_URL,process.env.PUBLIC_SUPA_R_KEY);export async function handler(e){if("POST"!==e.httpMethod)return{statusCode:405,body:"Method Not Allowed"};try{const{user_id:s}=JSON.parse(e.body);if(!s)return{statusCode:400,body:JSON.stringify({message:"Missing user_id"})};const{data:r,error:t}=await supabase.from("posts").select("id, file_path").eq("user_id",s);if(t)throw t;if(r&&r.length>0){const e=r.map((e=>e.id)),{error:s}=await supabase.from("stars").delete().in("post_id",e);if(s)throw s;const t=r.map((e=>e.file_path)).filter((e=>e));if(t.length>0){const{error:e}=await supabase.storage.from("uploads").remove(t);e&&console.error("Storage deletion error:",e)}}const{error:o}=await supabase.from("stars").delete().eq("user_id",s);if(o)throw o;const{error:a}=await supabase.from("posts").delete().eq("user_id",s);if(a)throw a;const{error:i}=await supabase.from("withdrawals").delete().eq("user_id",s);if(i)throw i;const{error:d}=await supabase.from("profiles").delete().eq("id",s);if(d)throw d;return{statusCode:200,body:JSON.stringify({success:!0,message:"Account deleted successfully."})}}catch(e){return console.error("Account deletion error:",e),{statusCode:500,body:JSON.stringify({message:"Failed to delete account: "+e.message})}}}
