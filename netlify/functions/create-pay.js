import{createClient}from"@supabase/supabase-js";const supabase=createClient(process.env.PUBLIC_SUPA_URL,process.env.PUBLIC_SUPA_R_KEY);export async function handler(e){console.log("Create Pay Function Started");try{const a=JSON.parse(e.body);console.log("Request Body:",a);const{email:r,cart:t}=a;if(!r)return{statusCode:400,body:JSON.stringify({error:"Email is required"})};if(!t||!Array.isArray(t)||0===t.length)return{statusCode:400,body:JSON.stringify({error:"Cart is empty or invalid"})};const s=t.reduce(((e,a)=>e+(a.price||0)),0);if(console.log("Calculated Total:",s),s<=0)return{statusCode:400,body:JSON.stringify({error:"Invalid total amount"})};const{data:o,error:n}=await supabase.from("transactions_b").insert([{email:r,amount:s,cart_data:t,status:"pending"}]).select().single();if(n)throw console.error("Supabase Transaction Error:",n),new Error(`Database error: ${n.message}`);if(console.log("Transaction created:",o.id),!process.env.PAYSTACK_SEC_KEY)throw new Error("Paystack secret key is missing");const i={email:r,amount:Math.round(100*s),currency:"NGN",metadata:{transaction_id:o.id,cart_count:t.length}};console.log("Paystack Request:",i);const c=await fetch("https://api.paystack.co/transaction/initialize",{method:"POST",headers:{Authorization:`Bearer ${process.env.PAYSTACK_SEC_KEY}`,"Content-Type":"application/json"},body:JSON.stringify(i)}),d=await c.text();console.log("Paystack Raw Response:",d);const l=JSON.parse(d);return l.status?(console.log("Paystack Success:",l),await supabase.from("transactions_b").update({reference:l.data.reference,status:"initialized"}).eq("id",o.id),{statusCode:200,body:JSON.stringify({authorization_url:l.data.authorization_url,reference:l.data.reference})}):(console.error("Paystack API Error:",l),await supabase.from("transactions_b").update({status:"failed",error_message:l.message}).eq("id",o.id),{statusCode:400,body:JSON.stringify({error:l.message||"Paystack initialization failed",details:l})})}catch(e){return console.error("Unhandled Error:",e),{statusCode:500,body:JSON.stringify({error:"Internal server error",message:e.message})}}}
